<!DOCTYPE html>
<html lang="de" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AykolinoApps - HTML-Translator Pro</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap" rel="stylesheet">
    
    <!-- Favicon (Platzhalter) -->
    <link rel="icon" href="favicon-32x32.png" type="image/x-icon">

    <style>
        /* --- GLOBALE STILE & FARBEN --- */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0a0a0a !important; /* Dunkler Hintergrund erzwungen */
            color: #f5f5f5;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Verlauf-Text */
        .gradient-text {
            background: linear-gradient(45deg, #3b82f6, #8b5cf6, #ec4899);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-fill-color: transparent;
        }

        /* Hintergrund-Leuchteffekt */
        .glow-effect {
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(139, 92, 246, 0.15) 0%, rgba(139, 92, 246, 0) 60%);
            animation: rotateGlow 15s linear infinite;
            z-index: -10;
            pointer-events: none;
        }

        @keyframes rotateGlow {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Header Animation */
        .header {
            animation: fadeInDown 0.8s ease-out;
        }

        .header-scrolled {
            background-color: rgba(10, 10, 10, 0.85);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Dropdown Styles */
        .lang-switcher-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 10px;
            background-color: #111827;
            border-radius: 0.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2);
            width: 160px; 
            z-index: 60;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s ease-out;
        }

        .lang-switcher-dropdown.open {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        /* Translator Specific Styles */
        .loader {
            border-top-color: #3b82f6;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .drag-over {
            border-color: #ec4899 !important; /* pink-500 */
            box-shadow: 0 0 20px rgba(236, 72, 153, 0.3);
            background-color: rgba(236, 72, 153, 0.05) !important;
        }

        /* Scrollbars */
        textarea::-webkit-scrollbar,
        pre::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        textarea::-webkit-scrollbar-track,
        pre::-webkit-scrollbar-track {
            background: #1f2937;
            border-radius: 4px;
        }
        textarea::-webkit-scrollbar-thumb,
        pre::-webkit-scrollbar-thumb {
            background-color: #4b5563;
            border-radius: 4px;
        }
        textarea::-webkit-scrollbar-thumb:hover,
        pre::-webkit-scrollbar-thumb:hover {
            background-color: #6b7280;
        }
    </style>
</head>
<body>

    <!-- Background Glow -->
    <div class="fixed top-0 left-0 w-full h-full overflow-hidden pointer-events-none">
        <div class="glow-effect"></div>
    </div>

    <!-- Header / Navigation -->
    <nav id="main-header" class="header fixed top-0 left-0 w-full z-50 transition-all duration-300">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-20">
                <a href="https://aykolino.de" class="text-2xl font-bold tracking-tight text-white hover:opacity-90 transition-opacity">
                    Aykolino<span class="gradient-text">Apps</span>
                </a>

                <!-- Desktop Navigation -->
                <div class="hidden md:flex items-center space-x-8">
                    <a href="https://uebermich.aykolino.de" class="text-gray-300 hover:text-white transition-colors font-medium" data-translate-key="navAbout">Über mich</a>
                    <a href="mailto:ayko.tiedtke2@yahoo.de" class="text-gray-300 hover:text-white transition-colors font-medium" data-translate-key="navContact">Kontakt</a>
                    
                    <!-- Sprachauswahl -->
                    <div class="relative lang-switcher">
                        <button id="lang-switcher-button" class="flex items-center text-gray-300 hover:text-white transition-colors py-2">
                            <img id="current-flag-desktop" src="https://flagcdn.com/w40/de.png" alt="DE" class="w-5 h-auto mr-2 rounded-sm object-cover shadow-sm">
                            <span id="current-lang-desktop" class="font-medium">DE</span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-1 opacity-70" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                        </button>
                        <div id="lang-switcher-dropdown" class="lang-switcher-dropdown p-1 space-y-0.5">
                            <a href="#" class="flex items-center w-full px-3 py-2 text-sm text-gray-200 hover:bg-gray-700 rounded-md transition-colors" onclick="setLanguage('de', event)">
                                <img src="https://flagcdn.com/w40/de.png" alt="DE" class="w-5 h-auto mr-3 rounded-sm"> <span>Deutsch</span>
                            </a>
                            <a href="#" class="flex items-center w-full px-3 py-2 text-sm text-gray-200 hover:bg-gray-700 rounded-md transition-colors" onclick="setLanguage('en', event)">
                                <img src="https://flagcdn.com/w40/gb.png" alt="EN" class="w-5 h-auto mr-3 rounded-sm"> <span>English</span>
                            </a>
                            <a href="#" class="flex items-center w-full px-3 py-2 text-sm text-gray-200 hover:bg-gray-700 rounded-md transition-colors" onclick="setLanguage('fr', event)">
                                <img src="https://flagcdn.com/w40/fr.png" alt="FR" class="w-5 h-auto mr-3 rounded-sm"> <span>Français</span>
                            </a>
                            <a href="#" class="flex items-center w-full px-3 py-2 text-sm text-gray-200 hover:bg-gray-700 rounded-md transition-colors" onclick="setLanguage('es', event)">
                                 <img src="https://flagcdn.com/w40/es.png" alt="ES" class="w-5 h-auto mr-3 rounded-sm"> <span>Español</span>
                            </a>
                        </div>
                    </div>
                </div>
                
                <!-- Mobile Menu Button -->
                <div class="md:hidden">
                    <button id="mobile-menu-button" class="text-white p-2 focus:outline-none">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Mobile Menu -->
        <div id="mobile-menu" class="hidden md:hidden bg-gray-900 border-b border-gray-800 absolute w-full left-0 top-20 shadow-xl">
            <a href="https://uebermich.aykolino.de" class="block py-4 px-6 text-sm text-gray-200 hover:bg-gray-800 border-b border-gray-800" data-translate-key="navAbout">Über mich</a>
            <a href="mailto:ayko.tiedtke2@yahoo.de" class="block py-4 px-6 text-sm text-gray-200 hover:bg-gray-800" data-translate-key="navContact">Kontakt</a>
            <div class="px-6 py-4 bg-gray-900/50">
                <p class="text-xs text-gray-500 uppercase tracking-wider mb-3 font-semibold" data-translate-key="languageLabelMobile">Sprache</p>
                <div class="grid grid-cols-2 gap-2">
                    <button class="flex items-center py-2 px-3 rounded bg-gray-800 hover:bg-gray-700 text-sm text-gray-300" onclick="setLanguage('de', event)">
                         <img src="https://flagcdn.com/w40/de.png" alt="DE" class="w-4 h-auto mr-2"> DE
                    </button>
                    <button class="flex items-center py-2 px-3 rounded bg-gray-800 hover:bg-gray-700 text-sm text-gray-300" onclick="setLanguage('en', event)">
                         <img src="https://flagcdn.com/w40/gb.png" alt="EN" class="w-4 h-auto mr-2"> EN
                    </button>
                    <button class="flex items-center py-2 px-3 rounded bg-gray-800 hover:bg-gray-700 text-sm text-gray-300" onclick="setLanguage('fr', event)">
                         <img src="https://flagcdn.com/w40/fr.png" alt="FR" class="w-4 h-auto mr-2"> FR
                    </button>
                    <button class="flex items-center py-2 px-3 rounded bg-gray-800 hover:bg-gray-700 text-sm text-gray-300" onclick="setLanguage('es', event)">
                         <img src="https://flagcdn.com/w40/es.png" alt="ES" class="w-4 h-auto mr-2"> ES
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Spacer für Fixed Header -->
    <div class="h-24"></div>

    <!-- MAIN CONTENT -->
    <main class="flex-grow container mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <div class="w-full max-w-6xl mx-auto">
            <div class="bg-slate-800/80 backdrop-blur-sm rounded-xl shadow-2xl p-6 sm:p-8 border border-slate-700/50">
                
                <header class="text-center mb-10">
                    <h1 class="text-3xl sm:text-5xl font-extrabold text-white tracking-tight mb-3">HTML Translator <span class="text-blue-500">Pro</span></h1>
                    <p class="text-slate-400 text-lg max-w-2xl mx-auto">Übersetzt den Text, behält die Struktur. Intelligenter Schutz für Variablen, Bilder und Shortcodes.</p>
                </header>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 md:gap-8">
                    <!-- Input Section -->
                    <div class="flex flex-col group">
                        <label for="html-input" class="text-sm font-semibold mb-2 text-slate-300 uppercase tracking-wide">Original HTML</label>
                        <div id="drop-zone" class="relative w-full h-80 flex-grow bg-slate-900/50 text-slate-300 border-2 border-dashed border-slate-600 rounded-xl p-4 transition-all duration-300 hover:border-blue-500 hover:bg-slate-900">
                            <textarea id="html-input" class="absolute inset-0 w-full h-full bg-transparent text-slate-300 border-none rounded-xl p-4 focus:outline-none resize-none font-mono text-sm leading-relaxed z-10" placeholder="HTML-Code hier einfügen oder Datei ablegen..."></textarea>
                            <div class="absolute inset-0 flex flex-col items-center justify-center text-slate-500 pointer-events-none transition-opacity duration-200" id="drop-zone-text">
                                <svg class="w-12 h-12 mb-3 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                                <span class="text-sm">Drag & Drop oder Einfügen</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Output Section -->
                    <div class="flex flex-col">
                        <label for="html-output" class="text-sm font-semibold mb-2 text-slate-300 uppercase tracking-wide flex justify-between items-center">
                            <span>Übersetzter Code</span>
                            <span id="output-lang-label" class="text-xs text-blue-400"></span>
                        </label>
                        <div id="output-container" class="relative w-full h-80 flex-grow bg-slate-900 border border-slate-700 rounded-xl overflow-hidden shadow-inner">
                            <pre class="w-full h-full overflow-auto custom-scrollbar"><code id="html-output" class="language-html whitespace-pre-wrap p-4 block font-mono text-sm leading-relaxed text-slate-300"></code></pre>
                            
                            <!-- Loading Overlay -->
                            <div id="loader" class="absolute inset-0 bg-slate-900/90 backdrop-blur-sm flex flex-col items-center justify-center hidden z-20">
                                <div class="loader ease-linear rounded-full border-4 border-t-4 border-slate-600 h-12 w-12 mb-4"></div>
                                <p class="text-blue-400 font-medium animate-pulse">Übersetze Inhalte...</p>
                            </div>

                            <!-- Small Copy Button Removed here -->
                        </div>
                    </div>
                </div>

                <!-- Controls -->
                <div class="mt-8 pt-8 border-t border-slate-700/50 flex flex-col sm:flex-row items-center justify-between gap-6">
                    <div class="relative w-full sm:w-72">
                        <label class="absolute -top-2.5 left-3 bg-slate-800 px-1 text-xs text-blue-400 font-semibold">Zielsprache</label>
                        <select id="language-select" class="w-full appearance-none bg-slate-900 text-white border border-slate-600 rounded-lg py-3 px-4 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all cursor-pointer">
                            <option value="de">Deutsch (German)</option>
                            <option value="en">Englisch (English)</option>
                            <option value="fr">Französisch (Français)</option>
                            <option value="it">Italienisch (Italiano)</option>
                            <option value="es">Spanisch (Español)</option>
                            <option value="nl">Niederländisch (Dutch)</option>
                            <option value="pl">Polnisch (Polish)</option>
                            <option value="tr">Türkisch (Turkish)</option>
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-slate-400">
                            <svg class="h-4 w-4 fill-current" viewBox="0 0 20 20"><path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/></svg>
                        </div>
                    </div>

                    <div class="flex flex-col sm:flex-row items-center gap-4 w-full sm:w-auto">
                        <button id="translate-btn" class="w-full sm:w-auto bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-500 hover:to-blue-600 text-white font-bold py-3 px-8 rounded-lg transition-all duration-200 transform hover:-translate-y-0.5 shadow-lg shadow-blue-900/20 active:scale-95">
                            Jetzt Übersetzen
                        </button>
                        <!-- Pink Copy Button (Moved here, replaced Download) -->
                        <button id="copy-btn" class="w-full sm:w-auto bg-pink-600 hover:bg-pink-700 text-white font-bold py-3 px-8 rounded-lg transition-all duration-200 transform hover:scale-105 shadow-lg flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg>
                            Kopieren
                        </button>
                    </div>
                </div>
                
                <div id="error-message" class="mt-6 p-4 rounded-lg bg-red-900/30 border border-red-800 text-red-200 text-center hidden animate-pulse text-sm"></div>
            </div>
            
            <div class="mt-6 text-center">
                 <p class="text-slate-500 text-xs">Hinweis: Dies ist ein client-seitiges Tool. Ihre Daten werden nicht dauerhaft gespeichert.</p>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="text-center py-8 border-t border-gray-800 bg-gray-900/50 mt-auto">
        <p class="text-gray-500 text-sm" data-translate-key="footerText">
            © <span id="year">2024</span> AykolinoApps. Mit Leidenschaft.
        </p>
        <p class="text-xs text-gray-600 mt-2" data-translate-key="footerDisclaimer">
            Diese Domain wird nicht für gewerbliche Zwecke genutzt.
        </p>
    </footer>

    <script>
        // --- Translations Data ---
        const translations = {
            'de': {
                langName: 'DE', flagUrl: 'https://flagcdn.com/w40/de.png',
                navAbout: 'Über mich', navContact: 'Kontakt', languageLabelMobile: 'Sprache:',
                footerText: '© <span id="year-footer"></span> AykolinoApps. Mit Leidenschaft.',
                footerDisclaimer: 'Diese Domain wird nicht für gewerbliche Zwecke genutzt.'
            },
            'en': {
                langName: 'EN', flagUrl: 'https://flagcdn.com/w40/gb.png',
                navAbout: 'About Me', navContact: 'Contact', languageLabelMobile: 'Language:',
                footerText: '© <span id="year-footer"></span> AykolinoApps. With passion.',
                footerDisclaimer: 'This domain is not used for commercial purposes.'
            },
            'fr': {
                langName: 'FR', flagUrl: 'https://flagcdn.com/w40/fr.png',
                navAbout: 'À propos de moi', navContact: 'Contact', languageLabelMobile: 'Langue:',
                footerText: '© <span id="year-footer"></span> AykolinoApps. Avec passion.',
                footerDisclaimer: "Ce domaine n'est pas utilisé à des fins commerciales."
            },
            'es': {
                langName: 'ES', flagUrl: 'https://flagcdn.com/w40/es.png',
                navAbout: 'Sobre mí', navContact: 'Contacto', languageLabelMobile: 'Idioma:',
                footerText: '© <span id="year-footer"></span> AykolinoApps. Con pasión.',
                footerDisclaimer: 'Este dominio no se utiliza con fines comerciales.'
            }
        };

        // --- Core Application Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- UI Elements ---
            const dropZone = document.getElementById('drop-zone');
            const htmlInput = document.getElementById('html-input');
            const dropZoneText = document.getElementById('drop-zone-text');
            const htmlOutput = document.getElementById('html-output');
            const languageSelect = document.getElementById('language-select');
            const translateBtn = document.getElementById('translate-btn');
            const copyBtn = document.getElementById('copy-btn');
            const loader = document.getElementById('loader');
            const errorMessage = document.getElementById('error-message');
            
            // --- Navigation Logic ---
            const langSwitcherButton = document.getElementById('lang-switcher-button');
            const langSwitcherDropdown = document.getElementById('lang-switcher-dropdown');
            const mobileMenuButton = document.getElementById('mobile-menu-button');
            const mobileMenu = document.getElementById('mobile-menu');
            const header = document.getElementById('main-header');

            // Set Year
            document.getElementById('year').textContent = new Date().getFullYear();

            // --- Drag & Drop & Input ---
            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    dropZone.classList.add('drag-over');
                });
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    dropZone.classList.remove('drag-over');
                });
            });

            dropZone.addEventListener('drop', (e) => {
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    const file = files[0];
                    if (file.type === "text/html" || file.name.endsWith('.html') || file.name.endsWith('.htm') || file.type === "text/plain") {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            htmlInput.value = event.target.result;
                            updatePlaceholder();
                            hideError();
                        };
                        reader.readAsText(file);
                    } else {
                        showError("Bitte nur HTML- oder Textdateien verwenden.");
                    }
                }
            });

            htmlInput.addEventListener('input', updatePlaceholder);

            function updatePlaceholder() {
                if (htmlInput.value.length > 0) {
                    dropZoneText.style.display = 'none';
                    dropZone.classList.add('bg-slate-900');
                    dropZone.classList.remove('bg-slate-900/50');
                } else {
                    dropZoneText.style.display = 'flex';
                    dropZone.classList.remove('bg-slate-900');
                    dropZone.classList.add('bg-slate-900/50');
                }
            }

            // --- Translation Logic (THE FIXES) ---
            translateBtn.addEventListener('click', handleTranslation);

            async function handleTranslation() {
                const htmlString = htmlInput.value;
                const targetLanguage = languageSelect.value;
                
                if (!htmlString.trim()) {
                    showError("Bitte geben Sie HTML-Code ein.");
                    return;
                }

                loader.classList.remove('hidden');
                htmlOutput.textContent = '';
                hideError();

                try {
                    // Create a DOM Parser instead of simple innerHTML to be safer with structure
                    // But for simple fragments, a div is still easiest for iteration.
                    const tempContainer = document.createElement('div');
                    tempContainer.innerHTML = htmlString;

                    const textNodes = []; 
                    const textsToTranslate = [];
                    
                    // Regex Definitions for protection
                    // 1. Image Files (common extensions)
                    const imageFileRegex = /(?:^|\s|["'])[\w-]+\.(?:jpg|jpeg|png|gif|webp|svg|bmp|ico)(?:$|\s|["'])/gi;
                    // 2. Shortcodes [foo]
                    const shortcodeRegex = /\[\s*\/?[^\]]+?\s*\]/g;
                    // 3. Template Variables: {{var}}, {var}, %var%, ${var}
                    const variableRegex = /\{\{.*?\}\}|\{.*?\}/g; // Common template engines (Liquid, Handlebars, React)
                    const percentVarRegex = /%.*?%/g; // Windows/Batch style or some CMS
                    const dollarVarRegex = /\$\{[^}]+\}/g; // JS Template Literals
                    // 4. Email Addresses
                    const emailRegex = /\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/g;

                    function walk(node) {
                        if (node.nodeType === 3) { // Text Node
                            const originalText = node.nodeValue;
                            
                            // Important: Skip if empty or just whitespace?
                            // No! Whitespace between spans (<span>A</span> <span>B</span>) is a text node.
                            // We must preserve it.
                            
                            // Skip only if parent is script/style
                            const parentTag = node.parentElement ? node.parentElement.nodeName : '';
                            if (parentTag === 'SCRIPT' || parentTag === 'STYLE' || parentTag === 'CODE' || parentTag === 'PRE') {
                                return;
                            }
                            
                            if (!originalText.trim()) {
                                // Node is purely whitespace. Keep it as is, do not translate.
                                return;
                            }

                            // EXTRACT WHITESPACE
                            const leadingSpace = originalText.match(/^\s*/)[0];
                            const trailingSpace = originalText.match(/\s*$/)[0];
                            let textToProcess = originalText.trim();

                            const placeholders = {};
                            let placeholderIndex = 0;

                            function addPlaceholder(match) {
                                const key = `__PH${placeholderIndex}__`; // Shorter key is better for API
                                placeholders[key] = match;
                                placeholderIndex++;
                                return key;
                            }

                            // PROTECT EVERYTHING
                            textToProcess = textToProcess.replace(imageFileRegex, (match) => {
                                // Careful not to replace quotes if captured, but regex above captures pure filename context mostly
                                // Let's keep it simple: if it matches the pattern, protect the whole match.
                                return addPlaceholder(match);
                            });
                            textToProcess = textToProcess.replace(emailRegex, addPlaceholder);
                            textToProcess = textToProcess.replace(variableRegex, addPlaceholder);
                            textToProcess = textToProcess.replace(percentVarRegex, addPlaceholder);
                            textToProcess = textToProcess.replace(dollarVarRegex, addPlaceholder);
                            textToProcess = textToProcess.replace(shortcodeRegex, addPlaceholder);

                            // Store for reconstruction
                            textNodes.push({ 
                                node: node, 
                                leadingSpace: leadingSpace,
                                trailingSpace: trailingSpace,
                                placeholders: placeholders, 
                                originalProcessedText: textToProcess 
                            });

                            textsToTranslate.push(textToProcess);

                        } else if (node.nodeType === 1) { // Element Node
                            // Link Adaptation
                            if (node.tagName === 'A' && node.hasAttribute('href')) {
                                const originalHref = node.getAttribute('href');
                                const newHref = updateLink(originalHref, targetLanguage);
                                node.setAttribute('href', newHref);
                            }
                            
                            // Do not translate content of these tags
                            if (node.tagName === 'SCRIPT' || node.tagName === 'STYLE' || node.tagName === 'CODE' || node.tagName === 'PRE') {
                                return;
                            }

                            for (let i = 0; i < node.childNodes.length; i++) {
                                walk(node.childNodes[i]);
                            }
                        }
                    }

                    walk(tempContainer);

                    if (textsToTranslate.length > 0) {
                        // Translate in batches or all at once? 
                        // Google API GET limit is around 2k-5k chars. Better to do it simply for now.
                        // For a robust app, one should batch. Here we assume small-medium inputs.
                        
                        // We translate each text node individually to preserve mapping.
                        // Parallel requests might hit rate limits, but for this demo it's okay.
                        // Optimization: Use Promise.all
                        
                        const translationPromises = textsToTranslate.map(text => translateText(text, targetLanguage));
                        const translationResults = await Promise.all(translationPromises);

                        textNodes.forEach((data, index) => {
                            let translatedText = translationResults[index] || data.originalProcessedText;

                            // Restore Placeholders
                            // We iterate keys to ensure we catch them all.
                            // Reverse order usually not needed if keys are unique.
                            for (const [key, val] of Object.entries(data.placeholders)) {
                                // Use a global replace for the key
                                // Handle potential spaces inserted by translator (e.g. __ PH0 __)
                                // The key is __PH\d+__
                                // Regex: __\s*PH(\d+)\s*__
                                const phId = key.match(/\d+/)[0];
                                const looseRegex = new RegExp(`__\\s*PH${phId}\\s*__`, 'gi');
                                translatedText = translatedText.replace(looseRegex, val);
                            }

                            // Restore Whitespace
                            data.node.nodeValue = data.leadingSpace + translatedText + data.trailingSpace;
                        });
                    }

                    htmlOutput.textContent = tempContainer.innerHTML;

                } catch (error) {
                    console.error(error);
                    showError("Fehler bei der Verarbeitung: " + error.message);
                    htmlOutput.textContent = htmlString; // Fallback
                } finally {
                    loader.classList.add('hidden');
                }
            }

            function updateLink(url, targetLang) {
                const tldMap = { 'de': '.de', 'en': '.com', 'fr': '.fr', 'it': '.it', 'es': '.es', 'nl': '.nl', 'pl': '.pl' };
                const targetTld = tldMap[targetLang];
                if (!targetTld) return url;

                // Simple Regex to replace TLD at end of domain
                try {
                    const urlObj = new URL(url); // Try parsing as URL
                    const hostname = urlObj.hostname;
                    const parts = hostname.split('.');
                    if (parts.length > 1) {
                         const lastPart = parts[parts.length - 1];
                         // Only replace if it looks like a standard TLD (2-3 chars) or common ones
                         if (lastPart.length >= 2 && !url.includes('localhost') && !url.includes('127.0.0.1')) {
                             const newHostname = hostname.substring(0, hostname.lastIndexOf('.')) + targetTld;
                             return url.replace(hostname, newHostname);
                         }
                    }
                    return url;
                } catch (e) {
                    // Not a full URL (relative), return as is
                    return url;
                }
            }

            async function translateText(text, targetLang) {
                if (!text || !text.trim()) return text;
                
                // Using the specific single endpoint
                const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=${targetLang}&dt=t&q=${encodeURIComponent(text)}`;
                
                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error("API Limit or Network Error");
                    const data = await response.json();
                    
                    // The result is often an array of sentences. Join them.
                    if (data && data[0]) {
                        return data[0].map(s => s[0]).join('');
                    }
                    return text;
                } catch (e) {
                    console.warn("Translation failed for chunk:", text, e);
                    return text; // Fallback to original
                }
            }

            // --- UI Helpers ---
            function showError(msg) {
                errorMessage.textContent = msg;
                errorMessage.classList.remove('hidden');
            }
            function hideError() {
                errorMessage.classList.add('hidden');
            }

            // --- NEW: Robust Copy Function ---
            copyBtn.addEventListener('click', () => {
                const textToCopy = htmlOutput.textContent;
                if (!textToCopy) return;

                // Funktion für Feedback-Animation
                const showSuccess = () => {
                    const originalContent = copyBtn.innerHTML;
                    const originalClasses = copyBtn.className;
                    
                    // Change Text and Icon
                    copyBtn.innerHTML = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg> Kopiert!`;
                    // Optional: Change color to green temporarily to indicate success
                    copyBtn.classList.remove('bg-pink-600', 'hover:bg-pink-700');
                    copyBtn.classList.add('bg-green-600', 'hover:bg-green-700');

                    setTimeout(() => {
                        copyBtn.innerHTML = originalContent;
                        // Restore original classes (remove green, add pink)
                        copyBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                        copyBtn.classList.add('bg-pink-600', 'hover:bg-pink-700');
                    }, 2000);
                };

                // Fallback Funktion
                const fallbackCopyTextToClipboard = (text) => {
                    const textArea = document.createElement("textarea");
                    textArea.value = text;
                    
                    // Style anpassen, damit es nicht sichtbar ist, aber im Viewport bleibt
                    textArea.style.position = "fixed";
                    textArea.style.left = "-9999px";
                    textArea.style.top = "0";
                    
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();

                    try {
                        const successful = document.execCommand('copy');
                        if (successful) {
                            showSuccess();
                        } else {
                            throw new Error('Fallback copy failed');
                        }
                    } catch (err) {
                        showError("Kopieren fehlgeschlagen: " + err);
                    }

                    document.body.removeChild(textArea);
                };

                // Versuche moderne API, sonst Fallback
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(textToCopy).then(() => {
                        showSuccess();
                    }).catch(err => {
                        console.warn("Clipboard API failed, trying fallback...", err);
                        fallbackCopyTextToClipboard(textToCopy);
                    });
                } else {
                    fallbackCopyTextToClipboard(textToCopy);
                }
            });

            // --- Language Switching (App UI) ---
            window.setLanguage = function(lang, event) {
                if (event) event.preventDefault();
                if (!translations[lang]) return;

                localStorage.setItem('language', lang);
                
                // Update Text
                document.querySelectorAll('[data-translate-key]').forEach(el => {
                    const key = el.getAttribute('data-translate-key');
                    if (translations[lang][key]) el.innerHTML = translations[lang][key];
                });

                // Update UI
                const currentLangLabel = document.getElementById('current-lang-desktop');
                const currentFlag = document.getElementById('current-flag-desktop');
                if (currentLangLabel) currentLangLabel.textContent = translations[lang].langName;
                if (currentFlag) currentFlag.src = translations[lang].flagUrl;

                // Close menus
                if (langSwitcherDropdown) langSwitcherDropdown.classList.remove('open');
                if (mobileMenu) mobileMenu.classList.add('hidden');
            };

            // Init UI Language
            const savedLang = localStorage.getItem('language') || 'de';
            setLanguage(savedLang);

            // Toggle Dropdown
            if(langSwitcherButton) {
                langSwitcherButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    langSwitcherDropdown.classList.toggle('open');
                });
            }
            window.addEventListener('click', () => {
                if(langSwitcherDropdown) langSwitcherDropdown.classList.remove('open');
            });
            if(mobileMenuButton) {
                mobileMenuButton.addEventListener('click', () => mobileMenu.classList.toggle('hidden'));
            }
            
            // Header Scroll
            window.addEventListener('scroll', () => {
                if (window.scrollY > 10) header.classList.add('header-scrolled');
                else header.classList.remove('header-scrolled');
            });
        });
    </script>
</body>
</html>
